C51 COMPILER V9.60.0.0   DRV_CC1101                                                        07/08/2021 21:47:58 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE DRV_CC1101
OBJECT MODULE PLACED IN .\Objects\drv_CC1101.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\ESC51_sdk\HW_Driver\drv_CC1101.c LARGE OPTIMIZE(8,SPEED) BROWSE IN
                    -CDIR(..\..\ESC51_sdk\es_sdkstatrt;..\..\ESC51_sdk\HW_Driver\header;..\..\ESC51_sdk\HW_Support\header;..\..\ESC51_sdk\SW_
                    -Support\header;..\..\ESC51_project;..\..\ESC51_sdk) DEBUG OBJECTEXTEND PRINT(.\Listings\drv_CC1101.lst) OBJECT(.\Objects
                    -\drv_CC1101.obj)

line level    source

   1          #include "drv_CC1101.h"
   2          
   3          
   4          #ifdef DRV_CC1101_CONFIG
              
              
              
              //10, 7, 5, 0, -5, -10, -15, -20, dbm output power, 0x12 == -30dbm
              const uint8_t PaTabel[ ] = { 0xc0, 0xC8, 0x84, 0x60, 0x68, 0x34, 0x1D, 0x0E};
              static const uint8_t CC1101InitData[ 22 ][ 2 ]= 
              {
                { CC1101_IOCFG0,      0x06 },
                { CC1101_FIFOTHR,     0x47 },
                { CC1101_PKTCTRL0,    0x05 },
                { CC1101_CHANNR,      0x96 }, //430M
                { CC1101_FSCTRL1,     0x06 },
                { CC1101_FREQ2,       0x0F },
                { CC1101_FREQ1,       0x62 },
                { CC1101_FREQ0,       0x76 },
                { CC1101_MDMCFG4,     0xF6 },
                { CC1101_MDMCFG3,     0x43 },
                { CC1101_MDMCFG2,     0x13 },
                { CC1101_DEVIATN,     0x15 },
                { CC1101_MCSM0,       0x18 },
                { CC1101_FOCCFG,      0x16 },
                { CC1101_WORCTRL,     0xFB },
                { CC1101_FSCAL3,      0xE9 },
                { CC1101_FSCAL2,      0x2A },
                { CC1101_FSCAL1,      0x00 },
                { CC1101_FSCAL0,      0x1F },
                { CC1101_TEST2,       0x81 },
                { CC1101_TEST1,       0x35 },
                { CC1101_MCSM1,       0x3B },
              };
              
              
              
              
              
              
              
              /**
                * @brief :1MSå»¶æ—¶å‡½æ•°
                * @param :
                * @note  :12MHz ä¸‹1MSå»¶æ—¶
                * @retval:æ— 
                */
              static void drv_delay_1ms( )
              {
                      uint16_t Ms = 1;
                      uint32_t j = 80;
                      
C51 COMPILER V9.60.0.0   DRV_CC1101                                                        07/08/2021 21:47:58 PAGE 2   

                      while( Ms-- )
                      {
                              while( j-- );
                      }
              }
              
              /**
                * @brief :MSå»¶æ—¶å‡½æ•°
                * @param :
                *                     @Ms:å»¶æ—¶çš„MSæ•°
                * @note  :æ— 
                * @retval:æ— 
                */
              static void drv_delay_ms( uint16_t Ms )
              {
                      while( Ms-- )
                      {
                              drv_delay_1ms( );
                      }
              }
              
              
              
              
              
              
              
              
              
              /**
                * @brief :CC1101å†™å‘½ä»¤
                * @param :
                *                     @Commandï¼šå‘½ä»¤
                * @note  :æ— 
                * @retval:æ— 
                */
              void CC1101_Write_Cmd( uint8_t Command )
              {
                  CC1101_SET_CSN_LOW( );                                      //SPIç‰‡é€‰ï¼Œæœ¬å·¥ç¨‹ä¸­è¯¥å‡½æ•°éƒ½æ˜¯ç”¨ä½œSPIç‰‡é€‰
                      
                  drv_spi_read_write_byte( Command );         //å†™å‘½ä»¤
                      
                  CC1101_SET_CSN_HIGH( );                                     //SPIå–æ¶ˆç‰‡é€‰ï¼Œæœ¬å·¥ç¨‹ä¸­è¯¥å‡½æ•°éƒ½æ˜¯ç”¨ä½œå–æ¶ˆSPIç‰‡é€‰                                    
              }
              
              /**
                * @brief :CC1101å†™å¯„å­˜å™¨
                * @param :
                *                     @Addrï¼šåœ°å€
                *                     @WriteValueï¼šå†™å…¥çš„æ•°æ®å­—èŠ‚
                * @note  :æ— 
                * @retval:æ— 
                */
              void CC1101_Write_Reg( uint8_t Addr, uint8_t WriteValue )
              {
                      CC1101_SET_CSN_LOW( );                                  
                      
                  drv_spi_read_write_byte( Addr );            //å†™åœ°å€
                  drv_spi_read_write_byte( WriteValue );      //å†™æ•°æ®
                      
                  CC1101_SET_CSN_HIGH( );                                     
              }
C51 COMPILER V9.60.0.0   DRV_CC1101                                                        07/08/2021 21:47:58 PAGE 3   

              
              /**
                * @brief :CC1101è¿ç»­å†™å¯„å­˜å™¨
                * @param :
                *                     @Addrï¼šåœ°å€
                *                     @pWriteBuffï¼šå†™å…¥çš„æ•°æ®ä¸²é¦–åœ°å€
                *                     @WriteSizeï¼šå†™å…¥çš„æ•°æ®ä¸ªæ•°
                * @note  :æ— 
                * @retval:æ— 
                */
              void CC1101_Write_Multi_Reg( uint8_t Addr, uint8_t *pWriteBuff, uint8_t WriteSize )
              {
                  uint8_t i;
                      
                  CC1101_SET_CSN_LOW( );                                      
                      
                  drv_spi_read_write_byte( Addr | WRITE_BURST );      //è¿ç»­å†™å‘½ä»¤ åŠé¦–åœ°å€
                  for( i = 0; i < WriteSize; i ++ )
                  {
                      drv_spi_read_write_byte( *( pWriteBuff + i ) ); //è¿ç»­å†™å…¥æ•°æ®
                  }
                      
                  CC1101_SET_CSN_HIGH( );                                     
              }
              
              /**
                * @brief :CC1101è¯»å¯„å­˜å™¨
                * @param :
                *                     @Addrï¼šåœ°å€
                * @note  :æ— 
                * @retval:å¯„å­˜å™¨å€¼
                */
              uint8_t CC1101_Read_Reg( uint8_t Addr )
              {
                  uint8_t l_RegValue = 0;
                      
                  CC1101_SET_CSN_LOW( );
                      
                  drv_spi_read_write_byte( Addr | READ_SINGLE );      //å•ç‹¬è¯»å‘½ä»¤ åŠåœ°å€
                  l_RegValue = drv_spi_read_write_byte( 0xFF );       //è¯»å–å¯„å­˜å™¨
                      
                  CC1101_SET_CSN_HIGH( );
                      
                  return l_RegValue;
              }
              
              /**
                * @brief :CC1101è¯»ä¸€ä¸ªå¯„å­˜å™¨çŠ¶æ€
                * @param :
                *                     @Addrï¼šåœ°å€
                * @note  :æ— 
                * @retval:å¯„å­˜å™¨çŠ¶æ€
                */
              uint8_t CC1101_Read_Status( uint8_t Addr )
              {
                  uint8_t l_RegStatus = 0;
                      
                  CC1101_SET_CSN_LOW( );
                      
                  drv_spi_read_write_byte( Addr | READ_BURST );       //è¿ç»­è¯»å‘½ä»¤ åŠåœ°å€
                  l_RegStatus = drv_spi_read_write_byte( 0xFF );      //è¯»å–çŠ¶æ€
                      
C51 COMPILER V9.60.0.0   DRV_CC1101                                                        07/08/2021 21:47:58 PAGE 4   

                  CC1101_SET_CSN_HIGH( );
                      
                  return l_RegStatus;
              }
              
              /**
                * @brief :CC1101è¿ç»­è¯»å¯„å­˜å™¨
                * @param :
                *                     @Addrï¼šåœ°å€
                *                     @pReadBuffï¼šè¯»å–æ•°æ®å­˜æ”¾é¦–åœ°å€
                *                     @ReadSizeï¼šè¯»å–æ•°æ®çš„ä¸ªæ•°
                * @note  :æ— 
                * @retval:æ— 
                */
              void CC1101_Read_Multi_Reg( uint8_t Addr, uint8_t *pReadBuff, uint8_t ReadSize )
              {
                  uint8_t i = 0, j = 0;
                      
                  CC1101_SET_CSN_LOW( );
                      
                  drv_spi_read_write_byte( Addr | READ_BURST);        //è¿ç»­è¯»å‘½ä»¤ åŠé¦–åœ°å€
                  for( i = 0; i < ReadSize; i ++ )
                  {
                      for( j = 0; j < 20; j ++ );
                      *( pReadBuff + i ) = drv_spi_read_write_byte( 0xFF );   //è¿ç»­è¯»å–æ•°æ®
                  }
                      
                  CC1101_SET_CSN_HIGH( );
              }
              
              /**
                * @brief :CC1101å‘é€æ¥æ”¶æ¨¡å¼è®¾ç½®
                * @param :
                *                     @Modeï¼šTX_MODEï¼Œå‘é€æ¨¡å¼ RX_MODEï¼Œæ¥æ”¶æ¨¡å¼
                * @note  :æ— 
                * @retval:å¯„å­˜å™¨çŠ¶æ€
                */
              void CC1101_Set_Mode( CC1101_ModeType Mode )
              {
                  if( Mode == TX_MODE )                       //å‘é€æ¨¡å¼
                  {
                      CC1101_Write_Reg( CC1101_IOCFG0,0x46 );
                      CC1101_Write_Cmd( CC1101_STX );         
                  }
                  else if( Mode == RX_MODE )          //æ¥æ”¶æ¨¡å¼
                  {
                      CC1101_Write_Reg(CC1101_IOCFG0,0x46);
                      CC1101_Write_Cmd( CC1101_SRX );
                  }
              }
              
              /**
                * @brief :CC1101è¿›å…¥ç©ºé—²æ¨¡å¼
                * @param :æ— 
                * @note  :æ— 
                * @retval:æ— 
                */ 
              void CC1101_Set_Idle_Mode( void )
              {
                  CC1101_Write_Cmd( CC1101_SIDLE );
              }
              
C51 COMPILER V9.60.0.0   DRV_CC1101                                                        07/08/2021 21:47:58 PAGE 5   

              /**
                * @brief :CC1101åˆå§‹åŒ–WORåŠŸèƒ½
                * @param :æ— 
                * @note  :æ— 
                * @retval:æ— 
                */ 
              void C1101_WOR_Init( void )
              {
                  CC1101_Write_Reg(CC1101_MCSM0,0x18);                
                  CC1101_Write_Reg(CC1101_WORCTRL,0x78); 
                  CC1101_Write_Reg(CC1101_MCSM2,0x00);
                  CC1101_Write_Reg(CC1101_WOREVT1,0x8C);
                  CC1101_Write_Reg(CC1101_WOREVT0,0xA0);
                      CC1101_Write_Cmd( CC1101_SWORRST );             //å†™å…¥WORå‘½ä»¤
              }
              
              /**
                * @brief :CC1101è®¾ç½®åœ°å€
                * @param :
                *                     @Addressï¼šè®¾ç½®çš„è®¾å¤‡åœ°å€å€¼
                *                     @AddressModeï¼šåœ°å€æ£€æµ‹æ¨¡å¼
                * @note  :æ— 
                * @retval:æ— 
                */
              void CC1101_Set_Address( uint8_t Address, CC1101_AddrModeType AddressMode)
              {
                  uint8_t btmp = 0;
                      
                      btmp = CC1101_Read_Reg( CC1101_PKTCTRL1 ) & ~0x03;      //è¯»å–CC1101_PKTCTRL1å¯„å­˜å™¨åˆå§‹å€¼
                  CC1101_Write_Reg( CC1101_ADDR, Address );                   //è®¾ç½®è®¾å¤‡åœ°å€
                      
                  if( AddressMode == BROAD_ALL )     { }                              //ä¸æ£€æµ‹åœ°å€
                  else if( AddressMode == BROAD_NO  )
                      { 
                              btmp |= 0x01;                                                                   //æ£€æµ‹åœ°å€ ä½†æ˜¯ä¸å¸¦å¹¿æ’­
                      }
                  else if( AddressMode == BROAD_0   )
                      { 
                              btmp |= 0x02;                                                                   //0x00ä¸ºå¹¿æ’­
                      }
                  else if( AddressMode == BROAD_0AND255 ) 
                      {
                              btmp |= 0x03;                                                                   //0x00 0xFFä¸ºå¹¿æ’­
                      } 
              
                      CC1101_Write_Reg( CC1101_PKTCTRL1, btmp);                       //å†™å…¥åœ°å€æ¨¡å¼    
              }
              
              /**
                * @brief :CC1101è®¾ç½®åŒæ­¥å­—æ®µ
                * @param :æ— 
                * @note  :æ— 
                * @retval:æ— 
                */
              void CC1101_Set_Sync( uint16_t Sync )
              {
                  CC1101_Write_Reg( CC1101_SYNC1, 0xFF & ( Sync >> 8 ) );
                  CC1101_Write_Reg( CC1101_SYNC0, 0xFF & Sync );      //å†™å…¥åŒæ­¥å­—æ®µ 16Bit
              }
              
              /**
                * @brief :CC1101æ¸…ç©ºå‘é€ç¼“å†²åŒº
C51 COMPILER V9.60.0.0   DRV_CC1101                                                        07/08/2021 21:47:58 PAGE 6   

                * @param :æ— 
                * @note  :æ— 
                * @retval:æ— 
                */ 
              void CC1101_Clear_TxBuffer( void )
              {
                  CC1101_Set_Idle_Mode( );                                    //é¦–å…ˆè¿›å…¥IDLEæ¨¡å¼
                  CC1101_Write_Cmd( CC1101_SFTX );                    //å†™å…¥æ¸…å‘é€ç¼“å†²åŒºå‘½ä»¤                
              }
              
              /**
                * @brief :CC1101æ¸…ç©ºæ¥æ”¶ç¼“å†²åŒº
                * @param :æ— 
                * @note  :æ— 
                * @retval:æ— 
                */
              void CC1101_Clear_RxBuffer( void )
              {
                  CC1101_Set_Idle_Mode();                                             //é¦–å…ˆè¿›å…¥IDLEæ¨¡å¼
                  CC1101_Write_Cmd( CC1101_SFRX );                    //å†™å…¥æ¸…æ¥æ”¶ç¼“å†²åŒºå‘½ä»¤
              }
              
              /**
                * @brief :CC1101å‘é€æ•°æ®åŒ…
                * @param :
                *                     @pTxBuffï¼šå‘é€æ•°æ®ç¼“å†²åŒº
                *                     @TxSizeï¼šå‘é€æ•°æ®é•¿åº¦
                *                     @DataModeï¼šæ•°æ®æ¨¡å¼
                * @note  :æ— 
                * @retval:æ— 
                */ 
              void CC1101_Tx_Packet( uint8_t *pTxBuff, uint8_t TxSize, CC1101_TxDataModeType DataMode )
              {
                  uint8_t Address;
                      
                  if( DataMode == BROADCAST )             
                      {
                              Address = 0; 
                      }
                  else if( DataMode == ADDRESS_CHECK )    
                      { 
                              Address = CC1101_Read_Reg( CC1101_ADDR ); 
                      }
              
                  CC1101_Clear_TxBuffer( );
                  
                  if(( CC1101_Read_Reg( CC1101_PKTCTRL1 ) & 0x03 ) != 0 )     
                  {
                      CC1101_Write_Reg( CC1101_TXFIFO, TxSize + 1 );          
                      CC1101_Write_Reg( CC1101_TXFIFO, Address );                     //å†™å…¥é•¿åº¦å’Œåœ°å€ ç”±äºå¤šä¸€ä¸ªå­—èŠ‚åœ°å€æ
             -­¤æ—¶é•¿åº¦åº”è¯¥åŠ 1
                  }
                  else
                  {
                      CC1101_Write_Reg( CC1101_TXFIFO, TxSize );                      //åªå†™é•¿åº¦ ä¸å¸¦åœ°å€
                  }
              
                  CC1101_Write_Multi_Reg( CC1101_TXFIFO, pTxBuff, TxSize );   //å†™å…¥æ•°æ®
                  CC1101_Set_Mode( TX_MODE );                                                         //å‘é€æ¨¡å¼
                      
                      while( 0 != CC1101_GET_GDO0_STATUS( ));
                      while( 0 == CC1101_GET_GDO0_STATUS( ));                                 //ç­‰å¾…å‘é€å®Œæˆ
C51 COMPILER V9.60.0.0   DRV_CC1101                                                        07/08/2021 21:47:58 PAGE 7   

              }
              
              /**
                * @brief :CC1101è¯»å–æ¥æ”¶åˆ°çš„å­—èŠ‚æ•°
                * @param :æ— 
                * @note  :æ— 
                * @retval:æ¥æ”¶åˆ°çš„æ•°æ®ä¸ªæ•°
                */
              uint8_t CC1101_Get_RxCounter( void )
              {
                  return ( CC1101_Read_Status( CC1101_RXBYTES ) & BYTES_IN_RXFIFO );  
              }
              
              /**
                * @brief :CC1101æ¥æ”¶æ•°æ®åŒ…
                * @param :
                *                     @RxBuffï¼šå‘é€æ•°æ®ç¼“å†²åŒº
                * @note  :æ— 
                * @retvalï¼šæ¥æ”¶åˆ°çš„å­—èŠ‚æ•°ï¼Œ0è¡¨ç¤ºæ— æ•°æ®
                */
              uint8_t CC1101_Rx_Packet( uint8_t *RxBuff )
              {
                      uint8_t l_PktLen = 0;
                  uint8_t l_Status[ 2 ] = { 0 };
              
                  if( 0 != CC1101_Get_RxCounter( ))
                  {
                      l_PktLen = CC1101_Read_Reg( CC1101_RXFIFO );           // è·å–é•¿åº¦ä¿¡æ¯
                              
                              if( ( CC1101_Read_Reg( CC1101_PKTCTRL1 ) & 0x03 ) != 0 )
                      {
                         CC1101_Read_Reg( CC1101_RXFIFO );                                    //å¦‚æœæ•°æ®åŒ…ä¸­åŒ…å«åœ°å€ä¿¡æ¯ ï¼Œåˆ™è¯»å–åœ°å€
             -ä¿¡æ¯
                      }
                      if( l_PktLen == 0 )           
                              {
                                      return 0;                       //æ— æ•°æ®
                              }
                      else 
                              {
                                      l_PktLen--;             //å‡å»ä¸€ä¸ªåœ°å€å­—èŠ‚
                              }
                      CC1101_Read_Multi_Reg( CC1101_RXFIFO, RxBuff, l_PktLen );       //è¯»å–æ•°æ®
                      CC1101_Read_Multi_Reg( CC1101_RXFIFO, l_Status, 2 );            //è¯»å–æ•°æ®åŒ…æœ€åä¸¤ä¸ªé¢å¤–å­—èŠ‚ï¼Œ
             -åä¸€ä¸ªä¸ºCRCæ ‡å¿—ä½
              
                      CC1101_Clear_RxBuffer( );
              
                      if( l_Status[ 1 ] & CRC_OK )
                              {   
                                      return l_PktLen; 
                              }
                      else
                              {   
                                      return 0; 
                              }
                  }
                  else   
                      {  
                              return 0; 
                      }                              
              }
C51 COMPILER V9.60.0.0   DRV_CC1101                                                        07/08/2021 21:47:58 PAGE 8   

              
              /**
                * @brief :CC1101å¤ä½
                * @param :æ— 
                * @note  :æ— 
                * @retval:æ— 
                */
              void CC1101_Reset( void )
              {
                      CC1101_SET_CSN_HIGH( );
                      CC1101_SET_CSN_LOW( );
                      CC1101_SET_CSN_HIGH( );
                      drv_delay_ms( 1 );
                      CC1101_Write_Cmd( CC1101_SRES );
              }
              
              /**
                * @brief :CC1101å¼•è„šåˆå§‹åŒ–
                * @param :æ— 
                * @note  :æ— 
                * @retval:æ— 
                */ 
              static void CC1101_Gpio_Init( void )
              {
                      //GDO0 GDO2é…ç½®ä¸ºè¾“å…¥
                      //éƒ¨åˆ†51å•ç‰‡æœºä¸éœ€è¦é…ç½®å¼•è„š
                      CC1101_GDO0_PxM0 = IO_IN_PUT_ONLY_M0 << CC1101_GDO0_PIN_BIT;
                      CC1101_GDO0_PxM1 = IO_IN_PUT_ONLY_M1 << CC1101_GDO0_PIN_BIT;
                      
                      CC1101_GDO2_PxM0 = IO_IN_PUT_ONLY_M0 << CC1101_GDO2_PIN_BIT;
                      CC1101_GDO2_PxM1 = IO_IN_PUT_ONLY_M1 << CC1101_GDO2_PIN_BIT;
                      
                      //åˆå§‹çŠ¶æ€ç½®é«˜
                      CC1101_GDO0 = 1;
                      CC1101_GDO2 = 0;
              }
              
              /**
                * @brief :CC1101åˆå§‹åŒ–
                * @param :æ— 
                * @note  :æ— 
                * @retval:æ— 
                */
              void CC1101_Init( void )
              {
                      uint8_t i = 0;
              
                      CC1101_Gpio_Init( );
                      CC1101_Reset( );    
              
                      for( i = 0; i < 22; i++ )
                      {
                              CC1101_Write_Reg( CC1101InitData[i][0], CC1101InitData[i][1] );
                      }
                      CC1101_Set_Address( 0x05, BROAD_0AND255 );
                      CC1101_Set_Sync( 0x8799 );
                      CC1101_Write_Reg(CC1101_MDMCFG1, 0x72);         //Modem Configuration
              
                      CC1101_Write_Multi_Reg( CC1101_PATABLE, (uint8_t*)PaTabel, 8 );
              }
              
              
C51 COMPILER V9.60.0.0   DRV_CC1101                                                        07/08/2021 21:47:58 PAGE 9   

              
              
              #endif /* DRV_CC1101_CONFIG */


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   ----    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
